# Data Model: Migrate Local PostgreSQL to Cloud Supabase

**Feature**: Migrate Local PostgreSQL to Cloud Supabase  
**Date**: 2025-01-27  
**Status**: Complete

## Database Context

The Supabase database uses a **multi-app database pattern** for POC/MVP purposes. The database contains multiple independent tables used by different applications:

- **Existing tables** (DO NOT MODIFY):
  - `patients` - Used by another application
  - `migration_checkpoints` - Used for migration tracking
  - `alembic_version` - Used for Alembic migrations

- **New table** (to be added):
  - `todos` - Used by this todo list application

These tables are independent with no foreign key relationships between them, allowing multiple apps to share the same database while maintaining data isolation.

## Entity: TodoItem

Represents a single TODO item in the system.

### Attributes

| Attribute | Type | Constraints | Description |
|-----------|------|-------------|-------------|
| `id` | Integer (Primary Key) | Auto-increment, Unique, Not Null | Unique identifier for the TODO item |
| `description` | String (Text) | Not Null, Not Empty | The text content describing the task. Supports Unicode, emojis, and multi-line text |
| `completed` | Boolean | Default: False, Not Null | Whether the item is completed (true) or pending (false) |
| `priority` | String | Default: 'Medium', Not Null | Priority level: 'Low', 'Medium', or 'High' |
| `due_date` | DateTime | Nullable | Optional due date for the task |
| `category` | String | Nullable | Optional category classification for the task |
| `created_at` | DateTime | Auto-set on creation, Not Null | Timestamp when the item was created |
| `updated_at` | DateTime | Auto-update on modification, Not Null | Timestamp when the item was last modified |

### Validation Rules

1. **Description Validation**:
   - Must not be empty or whitespace-only (trimmed)
   - Supports Unicode characters, emojis, and multi-line text
   - Validation occurs on both frontend (immediate feedback) and backend (security boundary)

2. **ID Validation**:
   - Auto-generated by database
   - Must be unique
   - Immutable after creation

3. **Completion Status**:
   - Boolean value (true/false)
   - Defaults to `false` (pending) on creation
   - Can be toggled between completed and pending

4. **Priority Validation**:
   - Must be one of: 'Low', 'Medium', 'High'
   - Defaults to 'Medium' if not specified
   - Case-sensitive string matching

5. **Due Date Validation**:
   - Optional field (can be null)
   - Must be a valid datetime if provided
   - No future date restrictions (can set past or future dates)

6. **Category Validation**:
   - Optional field (can be null)
   - Free-form string (no predefined categories)

7. **Timestamps**:
   - `created_at`: Set automatically on creation, never changes
   - `updated_at`: Set automatically on creation and updated on any modification

### State Transitions

```
[New] → created_at set, completed = false, priority = 'Medium'
  ↓
[Pending] → completed = false
  ↓
[Completed] → completed = true
  ↓
[Pending] → completed = false (can toggle back)
```

**Note**: There is no "deleted" state. Deletion removes the record entirely from the database.

### Database Schema

**Table Name**: `todos`

**PostgreSQL/Supabase Schema**:
```sql
CREATE TABLE todos (
    id SERIAL PRIMARY KEY,
    description TEXT NOT NULL,
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    priority VARCHAR NOT NULL DEFAULT 'Medium',
    due_date TIMESTAMP,
    category VARCHAR,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_todos_completed ON todos(completed);
CREATE INDEX idx_todos_priority ON todos(priority);
CREATE INDEX idx_todos_due_date ON todos(due_date) WHERE due_date IS NOT NULL;
```

**SQLAlchemy Model** (existing):
```python
class TodoItem(Base):
    __tablename__ = "todos"
    
    id = Column(Integer, primary_key=True, index=True)
    description = Column(Text, nullable=False)
    completed = Column(Boolean, default=False, nullable=False)
    priority = Column(String, default="Medium", nullable=False)
    due_date = Column(DateTime, nullable=True)
    category = Column(String, nullable=True)
    created_at = Column(DateTime, server_default=func.now(), nullable=False)
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now(), nullable=False)
```

### Relationships

**None**: This is a simple, single-entity model with no relationships to other entities. The `todos` table is independent from other tables in the Supabase database (`patients`, `migration_checkpoints`, `alembic_version`).

### Indexes

1. **Primary Key Index**: `id` (automatic)
2. **Completion Status Index**: `idx_todos_completed` on `completed` (for filtering completed vs pending items)
3. **Priority Index**: `idx_todos_priority` on `priority` (for filtering by priority)
4. **Due Date Index**: `idx_todos_due_date` on `due_date` (partial index for filtering by due date)

**Rationale**: 
- Primary key index enables fast lookups by ID
- Completion status index enables efficient filtering when displaying completed vs pending items
- Priority index supports filtering and sorting by priority
- Due date index (partial, only non-null values) supports date-based queries
- For up to 10,000 items, these indexes are sufficient

### Data Constraints

1. **Uniqueness**: `id` must be unique
2. **Non-nullability**: `id`, `description`, `completed`, `priority`, `created_at`, `updated_at` are required (NOT NULL)
3. **Content**: `description` must not be empty or whitespace-only after trimming
4. **Enum-like constraint**: `priority` should be 'Low', 'Medium', or 'High' (enforced at application level)

### Migration Mapping (Local PostgreSQL → Supabase)

- **Source**: Local PostgreSQL `todos` table with fields as defined above
- **Target**: Supabase `todos` table with matching fields and compatible types

- **Mapping rules**:
  - `id` → `id` (integer to integer, preserve values if possible, but may need sequence reset)
  - `description` → `description` (text to text)
  - `completed` → `completed` (boolean to boolean)
  - `priority` → `priority` (varchar to varchar)
  - `due_date` → `due_date` (timestamp to timestamp, nulls preserved)
  - `category` → `category` (varchar to varchar, nulls preserved)
  - `created_at` → `created_at` (timestamp to timestamp, preserve original timestamps)
  - `updated_at` → `updated_at` (timestamp to timestamp, preserve original timestamps)

- **Data integrity checks**:
  - Record count must match between source and destination
  - All non-null fields must have values
  - Timestamps must be preserved accurately
  - Priority values must be valid ('Low', 'Medium', 'High')

### Pydantic Schemas (API Layer)

#### TodoItemCreate (Request)
```python
class TodoItemCreate(BaseModel):
    description: str = Field(..., min_length=1, description="TODO item description")
    priority: Optional[str] = Field(default="Medium", pattern="^(Low|Medium|High)$")
    due_date: Optional[datetime] = None
    category: Optional[str] = None
```

#### TodoItemUpdate (Request)
```python
class TodoItemUpdate(BaseModel):
    description: Optional[str] = Field(None, min_length=1)
    completed: Optional[bool] = None
    priority: Optional[str] = Field(None, pattern="^(Low|Medium|High)$")
    due_date: Optional[datetime] = None
    category: Optional[str] = None
```

#### TodoItemResponse (Response)
```python
class TodoItemResponse(BaseModel):
    id: int
    description: str
    completed: bool
    priority: str
    due_date: Optional[datetime]
    category: Optional[str]
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True  # For SQLAlchemy model conversion
```

### TypeScript Types (Frontend)

```typescript
interface TodoItem {
  id: number;
  description: string;
  completed: boolean;
  priority: 'Low' | 'Medium' | 'High';
  due_date: string | null;  // ISO 8601 datetime string or null
  category: string | null;
  created_at: string;  // ISO 8601 datetime string
  updated_at: string;  // ISO 8601 datetime string
}

interface TodoItemCreate {
  description: string;
  priority?: 'Low' | 'Medium' | 'High';
  due_date?: string;  // ISO 8601 datetime string
  category?: string;
}

interface TodoItemUpdate {
  description?: string;
  completed?: boolean;
  priority?: 'Low' | 'Medium' | 'High';
  due_date?: string | null;  // ISO 8601 datetime string or null
  category?: string | null;
}
```

### Data Flow

1. **Create**: Frontend sends `TodoItemCreate` → Backend validates → Creates `TodoItem` → Returns `TodoItemResponse`
2. **Read**: Frontend requests by ID or list → Backend queries Supabase → Returns `TodoItemResponse`(s)
3. **Update**: Frontend sends `TodoItemUpdate` → Backend validates → Updates `TodoItem` → Returns `TodoItemResponse`
4. **Delete**: Frontend requests deletion → Backend deletes record from Supabase → Returns success/error

### Error Scenarios

1. **Empty/Whitespace Description**: 
   - Frontend: Prevents submission, shows inline validation
   - Backend: Returns 422 validation error

2. **Invalid Priority**:
   - Frontend: Prevents submission, shows inline validation
   - Backend: Returns 422 validation error

3. **Non-existent ID**:
   - Backend: Returns 404 Not Found
   - Frontend: Shows error message and refreshes list

4. **Concurrent Edits**:
   - Backend: Last write wins (no locking)
   - Frontend: May show stale data until refresh

5. **Supabase Connection Failure**:
   - Backend: Returns 503 Service Unavailable with clear error message
   - Frontend: Shows user-friendly error message

### Data Migration Strategy

**Migration Process**:
1. Stop application or put in read-only mode
2. Run `migrate_to_supabase.py` script
3. Script reads all records from local PostgreSQL
4. Script writes records to Supabase (with validation)
5. Script validates data integrity (record counts, field matching)
6. Update `DATABASE_URL` in `backend/.env` to point to Supabase
7. Restart application
8. Verify all operations work correctly

**Rollback Strategy**:
- Keep local PostgreSQL database intact until migration is verified
- Can revert `DATABASE_URL` to point back to local PostgreSQL if needed
- Data remains in local PostgreSQL as backup

### Data Integrity

1. **Referential Integrity**: N/A (no foreign keys)
2. **Check Constraints**: Priority values enforced by application validation
3. **Transaction Safety**: SQLAlchemy handles transactions automatically
4. **Concurrency**: Last-write-wins approach (no explicit locking)
5. **Multi-app Isolation**: `todos` table is independent from other tables in the database

### Performance Considerations

1. **Query Optimization**: 
   - Indexes on `completed`, `priority`, and `due_date` for filtering
   - Primary key index for lookups
   - Simple queries (no joins) = fast execution

2. **Data Volume**:
   - Designed for up to 10,000 items
   - Supabase handles this efficiently
   - No pagination needed at this scale

3. **Connection Pooling**:
   - SQLAlchemy connection pooling handles Supabase connections
   - Supabase connection limits apply (varies by plan)

4. **Network Latency**:
   - Cloud database adds network latency
   - Connection time target: < 5 seconds
   - Query time target: < 100ms p95

## Summary

The data model maintains simplicity while supporting the migration to Supabase:
- Single entity (TodoItem) with extended fields (priority, due_date, category)
- No relationships (independent from other tables in multi-app database)
- Clear validation rules
- Type-safe at both backend and frontend layers
- Optimized for the migration scale (up to 10,000 items)
- Compatible with Supabase PostgreSQL implementation

The `todos` table will be added to the existing Supabase database alongside other application tables, following a multi-app database pattern suitable for POC/MVP purposes.

