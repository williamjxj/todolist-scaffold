# Implementation Plan: Migrate Local PostgreSQL to Cloud Supabase

**Branch**: `002-supabase-migration` | **Date**: 2025-01-27 | **Spec**: `specs/002-supabase-migration/spec.md`  
**Input**: Feature specification from `/specs/002-supabase-migration/spec.md`

**Note**: This plan is generated by `/speckit.plan` for migrating from local PostgreSQL to cloud Supabase.

## Summary

Migrate the FastAPI backend's persistent storage from local PostgreSQL to cloud-hosted Supabase, enabling multi-environment access and cloud deployment. The migration preserves all existing todo data, adds a new `todos` table to the existing Supabase database (which already contains `patients`, `migration_checkpoints`, and `alembic_version` tables), and configures the application to use Supabase connection strings. The backend will later be deployed to Render cloud, requiring Supabase to be accessible from cloud environments.

## Technical Context

**Language/Version**: Python 3.12 (FastAPI backend), TypeScript/React frontend  
**Primary Dependencies**: FastAPI, SQLAlchemy, Supabase Python client, psycopg (PostgreSQL driver), React, Vite  
**Storage**: Supabase (cloud-hosted PostgreSQL) as primary persistent store, replacing local PostgreSQL  
**Testing**: pytest for backend, vitest for frontend  
**Target Platform**: Cloud deployment (Render) with local development support  
**Project Type**: Web application (separate `backend/` and `frontend/` apps)  
**Performance Goals**: Connection to Supabase within 5 seconds of startup, API p95 latency < 200ms (excluding external dependencies)  
**Constraints**: Must not modify existing Supabase tables (`patients`, `migration_checkpoints`, `alembic_version`); must support multi-app database pattern (POC/MVP); Supabase credentials stored in `backend/.env`  
**Scale/Scope**: Support up to 10,000 todo records; multi-environment configuration (dev, staging, production)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with all four core principles:

### I. Code Quality
- [x] Linting and formatting tools configured (repo already has Python and JS tooling)
- [x] Type safety requirements defined (Type hints in Python, TypeScript on frontend)
- [x] Code review process established (via Git branches/PRs)
- [x] Complexity limits defined (keep migration and connection logic small and well-documented)

### II. Testing Standards
- [x] Testing framework selected and configured (pytest, vitest)
- [x] Test coverage target defined (minimum 80% for new code)
- [x] Test categories identified (unit, integration, contract, E2E, performance)
- [x] Test infrastructure setup planned (Supabase-backed integration tests with test database)

### III. User Experience Consistency
- [x] Design system/component library selected (React + existing UI components)
- [x] Styling approach defined (Tailwind-based frontend)
- [x] Accessibility standards defined (follow WCAG 2.1 AA in UI; no new UI for this feature)
- [x] UX consistency requirements identified (API behavior must remain unchanged)

### IV. Performance Requirements
- [x] Performance budgets defined (Supabase connection < 5s, API p95 < 200ms)
- [x] Performance monitoring strategy planned (connection time logging, query performance tracking)
- [x] Performance testing approach defined (connection time tests, query performance benchmarks)
- [x] Core Web Vitals tracking planned (handled by existing frontend setup; not changed by this feature)

**Note**: All constitution requirements are met. The migration maintains existing API contracts and user experience while enabling cloud deployment.

## Project Structure

### Documentation (this feature)

```text
specs/002-supabase-migration/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (Supabase integration decisions)
├── data-model.md        # Phase 1 output (Todo entity, multi-app database pattern)
├── quickstart.md        # Phase 1 output (Supabase setup and migration guide)
├── contracts/           # Phase 1 output (OpenAPI contract, unchanged surface)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created here)
```

### Source Code (repository root)

```text
backend/
├── src/app/
│   ├── models.py        # SQLAlchemy models (TodoItem with __tablename__ = 'todos')
│   ├── database.py      # DB engine/session (updated for Supabase connection)
│   ├── config.py        # Settings (updated for Supabase env vars)
│   ├── services/        # Business logic (todo_service, unchanged)
│   ├── api/             # FastAPI routes (todos, unchanged)
│   └── main.py          # App entrypoint
├── init_db.py           # Schema initialization (updated for Supabase)
├── migrate_schema.py     # Schema migration script (updated for Supabase)
├── migrate_to_supabase.py  # NEW: Data migration script (local Postgres → Supabase)
└── tests/               # Backend tests (unit + integration with Supabase)

frontend/
├── src/
│   ├── components/      # React UI components (unchanged)
│   ├── hooks/           # `useTodos` hook (unchanged)
│   └── services/        # API client for todos (unchanged)
└── tests/               # Frontend tests (unchanged)
```

**Structure Decision**: Use existing `backend/` and `frontend/` layout; update backend database configuration, add Supabase migration script, and update documentation. The `todos` table will be added to the existing Supabase database alongside `patients`, `migration_checkpoints`, and `alembic_version` tables, following a multi-app database pattern for POC/MVP purposes.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None currently identified | N/A | N/A |
